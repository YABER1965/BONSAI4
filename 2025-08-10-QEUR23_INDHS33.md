---
title: QEUR23_INDHS33 - 閑話休題～カバラ数秘術をやってみる(簡便法NO2)  
date: 2025-08-10
tags: ["QEUシステム", "メトリックス", "Python言語", "Unsloth", "LLM", "データセット", "BONSAI", "LangGraph"]
excerpt: あたらしいLLMの学習体系を確立する
---

## QEUR23_INDHS33 - 閑話休題～カバラ数秘術をやってみる(簡便法NO2)    

## ～  前回より良化したが、再検討中 ～

D先生： “さて、前回のシステムは、実はダメダメなわけでした。そうですよね？それにしても、プログラムの処理結果が、以下のような**「納得性のちょっとある」**計算結果が出て来たのはおどろきでした。”

![imageINDS2-33-1](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-1.jpg) 

QEU:FOUNDER ： “まあ、あのロジック自体は全然だめです。たぶん、この2人で良い結果が出るように、AI君が忖度して結果を合わせ込みをしたんじゃないのかなあ・・・。もし、そうであるとすると**「AI恐るべし」**です・・・（笑）。今回は、ロジックをもう一歩レベルアップします。”

D先生： “どういう風に？”

**（セフィロットへの入力数値が１である場合）**

![imageINDS2-33-2](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-2.jpg) 

QEU:FOUNDER ： “入力する還元数毎のポイント表を作成しました。還元数というのは、以下のようなリストで表現されます。”

```python
# 性格評価マッピング
PERSONALITY_ASSESSMENT = {
    1: "リーダーシップに優れた開拓者。新しいことを始めるエネルギーに満ちています。",
    2: "調和と協力を重視する平和主義者。感受性が豊かで直感力に優れています。",
    3: "創造性と表現力豊かな芸術家タイプ。社交的で周囲を楽しませる才能があります。",
    4: "堅実で信頼できる実務家。組織や基盤を築くことに長けています。",
    5: "自由と変化を愛する冒険家。適応力が高く、多様な経験を求めます。",
    6: "家庭と奉仕を重視する慈愛の人。調和を創り出す能力に優れています。",
    7: "分析的で探究心の強い研究者タイプ。内省的で深い知恵を追求します。",
    8: "実務的で成功を追求する実業家タイプ。組織を管理し富を築く能力があります。",
    9: "理想主義で人道精神の強い博愛主義者。グローバルな視点を持っています。",
    11: "霊的直感に優れたビジョナリー。人々を啓発する能力があります。",
    22: "大きな夢を実現するマスタービルダー。壮大なプロジェクトを成功させます。",
    33: "奉仕と癒しを使命とする人道主義者。調和と平和をもたらします。"
}

```

D先生：“この表を、上記の数字で抽出するバージョンにするわけですね。このリストが当たっているかどうかは分かりませんが、計算ロジックの納得性が上がるので、結果として汎用性が上がるでしょう。で？今回の計測対象は？”

![imageINDS2-33-3](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-3.jpg) 

QEU:FOUNDER ： “例によって・・・。”

**(815氏)**

![imageINDS2-33-4](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-4.jpg) 

**(366氏)**

![imageINDS2-33-5](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-5.jpg) 

QEU:FOUNDER ： “**Ｊ国現代史のレジェンド**になろうとしている、このお二人です。先に要件定義書からいきましょう。小生のプログラムが気に入らなければ、この定義書を変えてＡＩに投げれば、よりよいプログラムができる。・・・かもしれません・・・（笑）。”

## カバラ数秘術分析プログラム 要件定義書

## 1. 概要

カバラ数秘術に基づき、個人の運勢・性格分析を行うプログラム。ヘブライ語名と生年月日を入力として、基本数値・セフィロト値・運勢評価・性格分析を出力する。

## 2. システム構成

### 2.1 主要コンポーネント

- 数値計算モジュール
- セフィロト計算モジュール
- 運勢評価モジュール
- レポート生成モジュール

### 2.2 技術スタック

- Python 3.x
- 主要ライブラリ: pandas, numpy, convertdate, matplotlib
- 日本語表示: japanize_matplotlib

## 3. 入力データ

| 項目 | データ型 | 必須 | 説明 | 例 |
|------|----------|------|------|-----|
| ヘブライ語名 | string | ✓ | ヘブライ文字で表記された名前 | "שִׁגֶרֻ יִשִׁבָ" |
| グレゴリオ暦生年月日 | string | ✓ | "YYYY-MM-DD"形式 | "1957-02-04" |

## 4. 出力データ

### 4.1 基本数値

| 項目 | 説明 | 計算方法 |
|------|------|----------|
| 運命数 | 人生の基本的な方向性 | ユダヤ暦年月日の各桁を還元し合計 |
| 表現数 | 外面に現れる性格 | 名前全体のゲマトリア値 |
| 魂の欲求数 | 内面の本質的欲求 | 母音部分のゲマトリア値 |
| 人格数 | 社会的人格 | 子音部分のゲマトリア値 |

### 4.2 セフィロト値 (生命の樹10属性)

| セフィラ | 説明 | 計算ロジック |
|----------|------|--------------|
| ケテル | 王冠 | 運命数をそのまま使用 |
| ホクマー | 知恵 | 誕生日/運命数/表現数/魂の欲求数が2→2, それ以外→誕生日の還元数 |
| ビナー | 理解 | 誕生月/運命数/表現数/魂の欲求数が3→3, それ以外→誕生月の還元数 |
| チェセド | 慈悲 | 誕生年/運命数/表現数/魂の欲求数が4→4, それ以外→誕生年の還元数 |
| ゲヴラ | 厳厲 | 表現数が5→5, それ以外→表現数の還元数 |
| ティファアレト | 美 | 運命数/表現数/和が6→6, それ以外→(運命数+表現数)の還元数 |
| ネツァフ | 勝利 | 魂の欲求数が7→7, それ以外→魂の欲求数の還元数 |
| ホド | 威光 | 運命数/表現数/人格数が8→8, それ以外→運命数の還元数 |
| イェソド | 基礎 | 表現数/人格数が9→9, それ以外→運命数の還元数 |
| マルクト | 王国 | 表現数/人格数/魂の欲求数が1or10→10, それ以外→(運命数+表現数+魂の欲求数)の還元数 |

### 4.3 運勢評価 (1-5点)

- 金・資産運
- 仕事・名声運
- 家庭運
- 人間関係・恋愛運
- 成長運
- 競争運
- 健康運

### 4.4 性格分析

運命数に対応した性格評価文を出力

### 4.5 ラッキーカラー

運命数に対応した色とその意味

## 5. 主要機能要件

### 5.1 数値計算機能

- ゲマトリア変換: ヘブライ文字→数値変換
- 数値還元: マスターナンバー(11,22,33)を考慮した桁和計算
- 母音/子音分離: 名前から母音部分を抽出

### 5.2 セフィロト計算機能

- 仕様変更に基づく条件分岐処理
- 各セフィラの計算ロジック実装
- 計算根拠の注記付き出力

### 5.3 運勢評価機能

- Excelベースの重みテーブル読み込み
- テーブル構造の自動検出と正規化
- セフィロト値に基づく運勢ポイント計算
- デフォルト値(3.0)のフォールバック処理

### 5.4 レポート生成機能

- ユダヤ暦変換処理
- 分析結果の整形出力
- エラーハンドリングとトレースバック表示

## 6. データストレージ

| データ種別 | 保存形式 | 場所 
|------------|----------|------|----------|
| 重みテーブル | Excel | fortune_table_new.xlsx | 
| マスタデータ | Python定数 | コード内 | 

## 7. 依存関係

### 必須ライブラリ

- pandas
- numpy
- convertdate
- matplotlib
- japanize-matplotlib
- scipy

D先生：“おっと、イケている定義書ですね。これは、DEEPSEEKで作ったのですか？。”

![imageINDS2-33-6](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-6.jpg) 

QEU:FOUNDER ： “たしか、これはDEEPSEEK製だったと思います。実は、これを載せた理由は、DEEPSEEKの定義書のほうが「チャちい」からです。変でしょう？つい最近、**QWENのモデルがアップグレードされており、性能が一気に上がってきた**んです。QWEN製のほうが出来がいいのだが、記事にすると長くなります。ちなみに、肝心のVibe Codingでも、QWENの方がレベルが高くなってきました。”

D先生：“DEEPSEEKも、すぐに**R2にアップグレードする**でしょうに・・・。”

QEU:FOUNDER ： “ありがたい競争ですね。それでは、カバラ数秘術の占いプログラムをドン！！”

```python
# ---
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from convertdate import hebrew
import datetime
import japanize_matplotlib
import hashlib
from scipy import signal
import os
import warnings
warnings.filterwarnings("ignore", category=UserWarning)
# --- カバラ数秘術設定 ---
NUMEROLOGY_COLORS = {
    1: ("赤", "創造・始源"),
    2: ("橙", "調和・受容"),
    3: ("黄", "表現・喜び"),
    4: ("緑", "基盤・安定"),
    5: ("青", "自由・変革"),
    6: ("藍", "愛・調和"),
    7: ("紫", "叡智・神秘"),
    8: ("金", "力・豊穣"),
    9: ("白", "完成・英知"),
    11: ("銀", "啓示・霊性"),
    22: ("金", "巨匠・実現"),
    33: ("虹", "奉仕・調和")
}
# 性格評価マッピング
PERSONALITY_ASSESSMENT = {
    1: "リーダーシップに優れた開拓者。新しいことを始めるエネルギーに満ちています。",
    2: "調和と協力を重視する平和主義者。感受性が豊かで直感力に優れています。",
    3: "創造性と表現力豊かな芸術家タイプ。社交的で周囲を楽しませる才能があります。",
    4: "堅実で信頼できる実務家。組織や基盤を築くことに長けています。",
    5: "自由と変化を愛する冒険家。適応力が高く、多様な経験を求めます。",
    6: "家庭と奉仕を重視する慈愛の人。調和を創り出す能力に優れています。",
    7: "分析的で探究心の強い研究者タイプ。内省的で深い知恵を追求します。",
    8: "実務的で成功を追求する実業家タイプ。組織を管理し富を築く能力があります。",
    9: "理想主義で人道精神の強い博愛主義者。グローバルな視点を持っています。",
    11: "霊的直感に優れたビジョナリー。人々を啓発する能力があります。",
    22: "大きな夢を実現するマスタービルダー。壮大なプロジェクトを成功させます。",
    33: "奉仕と癒しを使命とする人道主義者。調和と平和をもたらします。"
}
# ヘブライ文字のゲマトリア値
GEMATRIA_MAP = {
    'א': 1, 'ב': 2, 'ג': 3, 'ד': 4, 'ה': 5,
    'ו': 6, 'ז': 7, 'ח': 8, 'ט': 9, 'י': 10,
    'כ': 20, 'ל': 30, 'מ': 40, 'נ': 50, 'ס': 60,
    'ע': 70, 'פ': 80, 'צ': 90, 'ק': 100, 'ר': 200,
    'ש': 300, 'ת': 400,
    'ך': 20, 'ם': 40, 'ן': 50, 'ף': 80, 'ץ': 90  # 語末形
}
# 母音文字（補足的な母音記号を追加）
VOWELS = ['א', 'ה', 'ו', 'י', 'ַ', 'ָ', 'ֶ', 'ֵ', 'ִ', 'ֳ', 'ְ']

def calculate_numerology(value, reduce_master=True):
    """数値をカバラ数に還元（マスターナンバー対応）"""
    if not isinstance(value, int):
        digits = ''.join(filter(str.isdigit, str(value)))
        total = sum(int(d) for d in digits) if digits else 0
    else:
        total = value
    # マスターナンバーチェック
    if reduce_master and total in (11, 22, 33):
        return total
    while total > 9 and total not in (11, 22, 33):
        total = sum(int(d) for d in str(total))
    return total

def hebrew_to_gematria(name):
    """ヘブライ語名をゲマトリア変換"""
    # 母音記号を除外して計算
    consonants = ''.join([c for c in name if c not in VOWELS])
    return sum(GEMATRIA_MAP.get(char, 0) for char in consonants)

def extract_vowels(name):
    """ヘブライ語名から母音部分を抽出"""
    return ''.join([c for c in name if c in VOWELS])

def calculate_destiny_number(h_year, h_month, h_day):
    """運命数を正しい方法で計算"""
    # 5000年のケタを削除
    h_year = h_year % 5000
    
    # 年月日をそれぞれ還元し、合計
    year_reduced = calculate_numerology(h_year)
    month_reduced = calculate_numerology(h_month)
    day_reduced = calculate_numerology(h_day)
    
    # 合計を還元
    total = year_reduced + month_reduced + day_reduced
    return calculate_numerology(total)

def calculate_sefirot(base_values):
    """生命の樹セフィラを仕様変更に従って計算"""
    # 基本数値を取得
    destiny = base_values['destiny']
    month = base_values['month']
    day = base_values['day']
    year_reduced = base_values['year_reduced']
    expression = base_values['expression']
    soul = base_values['soul']
    personality = base_values['personality']
    
    # 1. ケテル (運命数) - 仕様の変更なし
    ketel = destiny
    
    # 2. ホクマー (知恵)
    # 誕生日、運命数、表現数、魂の欲求数が2のとき：ホクマーへの入力数は2とする
    # 上記が2以外のとき：ホクマーへの入力数は誕生日の還元数とする
    if day == 2 or destiny == 2 or expression == 2 or soul == 2:
        hochma = 2
    else:
        hochma = calculate_numerology(day)
    
    # 3. ビナー (理解)
    # 誕生月、運命数、表現数、魂の欲求数が3のとき：ビナーへの入力数は3とする
    # 上記が3以外のとき：ビナーへの入力数は誕生月の還元数とする
    if month == 3 or destiny == 3 or expression == 3 or soul == 3:
        binah = 3
    else:
        binah = calculate_numerology(month)
    
    # 4. チェセド (慈悲)
    # 誕生年、運命数、表現数、魂の欲求数が4のとき：チェセドへの入力数は4とする
    # 上記が4以外のとき：チェセドへの入力数は誕生年の還元数とする
    if year_reduced == 4 or destiny == 4 or expression == 4 or soul == 4:
        chesed = 4
    else:
        chesed = year_reduced  # すでに還元済み
    
    # 5. ゲヴラ (厳厲)
    # 表現数が5のとき：ゲヴラへの入力数は5とする
    # 表現数が5以外のとき：ゲヴラへの入力数は表現数の還元数とする
    if expression == 5:
        gevurah = 5
    else:
        gevurah = calculate_numerology(expression)
    
    # 6. ティファアレト (美)
    # 運命数または表現数または双方の和が6のとき：ティファアレトへの入力数は6とする
    # 運命数または表現数または双方の和が6以外のとき：ティファアレトへの入力数は(運命数 + 表現数の和)の還元数とする
    if destiny == 6 or expression == 6 or (destiny + expression) == 6:
        tiphereth = 6
    else:
        tiphereth = calculate_numerology(destiny + expression)
    
    # 7. ネツァフ (勝利)
    # 魂の欲求数が7のとき：ネツァフへの入力数は7とする
    # 魂の欲求数7以外のとき：ネツァフへの入力数は魂の欲求数の還元数とする
    if soul == 7:
        netzach = 7
    else:
        netzach = calculate_numerology(soul)
    
    # 8. ホド (威光)
    # 運命数または表現数または人格数が8のとき：ホドへの入力数は8とする
    # 運命数または表現数と人格数がすべて8以外のとき：ホドへの入力数は運命数の還元数とする
    if destiny == 8 or expression == 8 or personality == 8:
        hod = 8
    else:
        hod = calculate_numerology(destiny)
    
    # 9. イェソド (基礎)
    # 表現数または人格数が9のとき：イェソドへの入力数は9とする
    # 表現数と人格数が双方ともに9以外のとき：イェソドへの入力数は運命数の還元数とする
    if expression == 9 or personality == 9:
        yesod = 9
    else:
        yesod = calculate_numerology(destiny)
    
    # 10. マルクト (王国)
    # 表現数、人格数と魂の欲求数のどれかが1または10のとき：マルクトの値は10とする
    # 表現数、人格数と魂の欲求数がすべて1または10以外のとき：マルクトへの入力数は運命数、表現数、魂の欲求数を合計した還元数とする
    if expression == 1 or expression == 10 or personality == 1 or personality == 10 or soul == 1 or soul == 10:
        malkuth = 10
    else:
        malkuth = calculate_numerology(destiny + expression + soul)
    
    return [ketel, hochma, binah, chesed, gevurah, tiphereth, netzach, hod, yesod, malkuth]

def load_fortune_tables():
    """修正: 運勢重みテーブルを正しいファイル名で読み込む"""
    excel_file = "/content/drive/MyDrive/fortune_table_new.xlsx"  # ファイル名を修正
    tables = {}
    # テーブルが存在しない場合のデフォルト値
    default_table = pd.DataFrame({
        '金・資産運': [3]*10,
        '仕事・名声運': [3]*10,
        '家庭運': [3]*10,
        '人間関係・恋愛運': [3]*10,
        '成長運': [3]*10,
        '競争運': [3]*10,
        '健康運': [3]*10
    }, index=range(1,11))
    
    if not os.path.exists(excel_file):
        print(f"警告: {excel_file} が見つかりません。デフォルト値を使用します。")
        for num in list(range(1,10)) + [11,22,33]:
            tables[num] = default_table
        return tables
    
    try:
        # シート名の正確なマッピング
        sheet_name_map = {
            1: "数値-1（新規性・独立性）",
            2: "数値-2（協調性・感受性）",
            3: "数値-3（創造性・社交性）",
            4: "数値-4（安定性・勤勉性）",
            5: "数値-5（自由・変化）",
            6: "数値-6（調和・責任）",
            7: "数値-7（内省・精神性）",
            8: "数値-8（権力・物質成功）",
            9: "数値-9（奉仕・完成）",
            11: "数値-11（直感・理想主義）",
            22: "数値-22（現実化・大業成就）",
            33: "数値-33（啓蒙・奉仕）"
        }
        
        # 全シートを一度読み込み
        all_sheets = pd.read_excel(excel_file, sheet_name=None)
        
        # 各数値に対応するシートを処理
        for num, sheet_name in sheet_name_map.items():
            if sheet_name not in all_sheets:
                print(f"警告: シート '{sheet_name}' が見つかりません。デフォルト値を使用します。")
                tables[num] = default_table
                continue
                
            df = all_sheets[sheet_name].copy()
            
            # 列名の正規化
            df.columns = [str(col).strip().replace(' ', ' ') for col in df.columns]
            
            # "NO"列の存在確認
            no_col = next((col for col in df.columns if 'no' in str(col).lower()), None)
            if no_col is None:
                print(f"警告: {sheet_name} にNO列が見つかりません。デフォルト値を使用します。")
                tables[num] = default_table
                continue
                
            # 必要な運勢列の存在確認とマッピング
            standard_columns = ['金・資産運', '仕事・名声運', '家庭運', 
                              '人間関係・恋愛運', '成長運', '競争運', '健康運']
            column_mapping = {}
            
            for std_col in standard_columns:
                for col in df.columns:
                    if std_col.replace('・', '') in str(col).replace('・', '') and 'no' not in str(col).lower():
                        column_mapping[col] = std_col
                        break
            
            # マッピングが完了した列だけを抽出
            valid_columns = [no_col] + [col for col in df.columns if col in column_mapping]
            df = df[valid_columns].copy()
            df.rename(columns=column_mapping, inplace=True)
            
            # "評価不要"をNaNに変換し、数値に変換
            for col in standard_columns:
                if col in df.columns:
                    df[col] = df[col].apply(
                        lambda x: np.nan if str(x).strip() == '評価不要' else x
                    )
                    df[col] = pd.to_numeric(df[col], errors='coerce')
            
            # インデックスを設定
            df.set_index(no_col, inplace=True)
            
            # 必要な行（1-10）が存在するか確認し、欠損値を補完
            result_df = pd.DataFrame(index=range(1, 11))
            for col in standard_columns:
                if col in df.columns:
                    result_df[col] = df[col].reindex(range(1, 11)).fillna(3)
                else:
                    result_df[col] = 3
                    
            tables[num] = result_df
            
    except Exception as e:
        print(f"エラー: テーブル読み込み中にエラーが発生しました - {str(e)}")
        for num in list(range(1,10)) + [11,22,33]:
            tables[num] = default_table
            
    return tables

```

D先生： “結局のところ、セフィロット（セフィラ）の計算方法が変わったんでしょう？”

### 1.ケテル(王冠)の計算方法 : 運命数を考慮する

- 仕様の変更なし

### 2.ホクマー(知恵)の計算方法 : 誕生日、運命数、表現数、魂の欲求数を考慮する

- 誕生日、運命数、表現数、魂の欲求数が2のとき：ホクマーへの入力数は2とする。
- 上記が2以外のとき：ホクマーへの入力数は誕生日の還元数とする

### 3.ビナー(理解)の計算方法 : 誕生月、運命数、表現数、魂の欲求数を考慮する

- 誕生月、運命数、表現数、魂の欲求数が3のとき：ビナーへの入力数は3とする。
- 上記が3以外のとき：ビナーへの入力数は誕生月の還元数とする。

### 4.チェセド(慈悲)の計算方法 : 誕生年、運命数、表現数、魂の欲求数を考慮する

- 誕生年、運命数、表現数、魂の欲求数が4のとき：チェセドへの入力数は4とする。
- 上記が4以外のとき：チェセドへの入力数は誕生年の還元数とする。

### 5.ゲヴラ(厳厲)の計算方法 : 表現数を考慮する

- 表現数が5のとき：ゲヴラへの入力数は5とする。
- 表現数が5以外のとき：ゲヴラへの入力数は表現数の還元数とする。

### 6.ティファアレト(美)の計算方法 : 運命数、表現数を考慮する

- 運命数または表現数または双方の和が6のとき：ティファアレトへの入力数は6とする。
- 運命数または表現数または双方の和が6以外のとき：ティファアレトへの入力数は(運命数 + 表現数の和)の還元数とする。

### 7.ネツァフ(勝利)の計算方法: 魂の欲求数を考慮する

- 魂の欲求数が７のとき：ネツァフへの入力数は7とする。
- 魂の欲求数7以外のとき：ネツァフへの入力数は魂の欲求数の還元数とする。

### 8.ホド(威光)の計算方法 : 運命数、表現数と人格数を考慮する

- 運命数または表現数または人格数が８のとき：ホドへの入力数は8とする。
- 運命数または表現数と人格数がすべて８以外のとき：ホドへの入力数は運命数の還元数とする。

### 9.イェソド(基礎)の計算方法 : 運命数、表現数と人格数を考慮する

- 表現数または人格数が9のとき：イェソドへの入力数は9とする。
- 表現数と人格数が双方ともに9以外のとき：イェソドへの入力数は運命数の還元数とする。

### 10.マルクト(王国)の計算方法 : 運命数、表現数、魂の欲求数と人格数を考慮する

- 表現数、人格数と魂の欲求数のどれかが1または10のとき：マルクトの値は１0とする。
- 表現数、人格数と魂の欲求数がすべて1または10以外のとき：マルクトへの入力数は運命数、表現数、魂の欲求数を合計した還元数とする。

QEU:FOUNDER ： “そうです。セフィロットの計算方法は、実は大変に複雑なんです。小生も本やWebを漁ったのだが、正しい(オーソライズされた)答えを得ることはできなかったです。結局、小生が苦肉の策でやったのは、AIに非常に多数の質問してかき集めた「推測（占い）モデル」でしかないのです。ココの部分は、大いに改善の余地がありますよ。さて、つづきに行きましょう。”

```python
def calculate_fortune_points(sefirot_values, fortune_tables):
    """セフィロト値から運勢ポイントを正しい方法で計算"""
    categories = ['金・資産運', '仕事・名声運', '家庭運', '人間関係・恋愛運', '成長運', '競争運', '健康運']
    points = {cat: 0.0 for cat in categories}
    counts = {cat: 0 for cat in categories}
    
    for i, value in enumerate(sefirot_values):
        sefira_num = i + 1
        numer_value = value  # セフィラの値を直接使用（還元は事前に実施済み）
        
        # 重みテーブル取得
        table = fortune_tables.get(numer_value, None)
        if table is None:
            continue
            
        # 評価不要のセルをスキップ
        for cat in categories:
            if sefira_num in table.index:
                weight = table.at[sefira_num, cat]
                if not pd.isna(weight) and weight != '評価不要':
                    try:
                        points[cat] += float(weight)
                        counts[cat] += 1
                    except:
                        continue
    
    # 平均を計算
    for cat in categories:
        if counts[cat] > 0:
            points[cat] = round(points[cat] / counts[cat], 1)
        else:
            points[cat] = 3.0  # デフォルト値
            
    return points

def kabala_numerology_analysis(gregorian_date, hebrew_name, show_chart=False):
    """修正: カバラ数秘術の全分析を仕様変更に従って実行"""
    try:
        # 生年月日解析
        birth_date = datetime.datetime.strptime(gregorian_date, "%Y-%m-%d")
        g_year, g_month, g_day = birth_date.year, birth_date.month, birth_date.day
        
        # ヘブライ暦変換
        h_year, h_month, h_day = hebrew.from_gregorian(g_year, g_month, g_day)
        
        # 5000年のケタを削除
        h_year = h_year % 5000
        
        # 運命数計算（修正）
        destiny_reduced = calculate_destiny_number(h_year, h_month, h_day)
        
        # 名前のゲマトリア計算
        expression_raw = hebrew_to_gematria(hebrew_name)
        expression_reduced = calculate_numerology(expression_raw)
        
        # 魂の欲求数 (母音部分)
        soul_vowels = extract_vowels(hebrew_name)
        soul_raw = hebrew_to_gematria(soul_vowels)  # 母音部分のゲマトリア
        soul_reduced = calculate_numerology(soul_raw)
        
        # 人格数 (子音部分)
        personality_raw = expression_raw - soul_raw  # 子音 = 全体 - 母音
        personality_reduced = calculate_numerology(personality_raw)
        
        # 基本数値
        base_values = {
            'gregorian': gregorian_date,
            'hebrew_name': hebrew_name,
            'destiny': destiny_reduced,
            'month': h_month,
            'day': h_day,
            'expression': expression_reduced,
            'year_reduced': calculate_numerology(h_year),
            'soul': soul_reduced,
            'personality': personality_reduced
        }
        
        destiny_num = base_values['destiny']
        destiny_color, destiny_meaning = NUMEROLOGY_COLORS.get(destiny_num, ("", ""))
        
        # セフィロト計算（仕様変更後）
        sefirot_values = calculate_sefirot(base_values)
        
        # 重みテーブル読み込み
        fortune_tables = load_fortune_tables()
        
        # 運勢ポイント計算
        fortune_points = calculate_fortune_points(sefirot_values, fortune_tables)
        
        # 性格評価
        personality = PERSONALITY_ASSESSMENT.get(destiny_num, "独自の才能と個性を持つ人物。")
        
        # レポート生成
        report = f"""
============================================================
カバラ数秘術占いプログラム (仕様変更版)
============================================================
ヘブライ語氏名: {hebrew_name}
グレゴリオ生年月日: {gregorian_date}
ユダヤ歴生年月日: {h_year}年 {h_month}月 {h_day}日
============================================================
■ 基本数値:
運命数: {destiny_reduced}
表現数: {expression_reduced} (還元前: {expression_raw})
魂の欲求数: {soul_reduced} (還元前: {soul_raw})
人格数: {personality_reduced} (還元前: {personality_raw})
■ 生命の樹セフィラ値 (仕様変更後):
1. ケテル (王冠): {sefirot_values[0]} {"(運命数)"}
2. ホクマー (知恵): {sefirot_values[1]} {"(誕生日の還元数)" if sefirot_values[1] != 2 else "(条件一致: 2)"}
3. ビナー (理解): {sefirot_values[2]} {"(誕生月の還元数)" if sefirot_values[2] != 3 else "(条件一致: 3)"}
4. チェセド (慈悲): {sefirot_values[3]} {"(誕生年の還元数)" if sefirot_values[3] != 4 else "(条件一致: 4)"}
5. ゲヴラ (厳厲): {sefirot_values[4]} {"(表現数の還元数)" if sefirot_values[4] != 5 else "(条件一致: 5)"}
6. ティファアレト (美): {sefirot_values[5]} {"(運命数+表現数の還元数)" if sefirot_values[5] != 6 else "(条件一致: 6)"}
7. ネツァフ (勝利): {sefirot_values[6]} {"(魂の欲求数の還元数)" if sefirot_values[6] != 7 else "(条件一致: 7)"}
8. ホド (威光): {sefirot_values[7]} {"(運命数の還元数)" if sefirot_values[7] != 8 else "(条件一致: 8)"}
9. イェソド (基礎): {sefirot_values[8]} {"(運命数の還元数)" if sefirot_values[8] != 9 else "(条件一致: 9)"}
10. マルクト (王国): {sefirot_values[9]} {"(運命数+表現数+魂の欲求数の還元数)" if sefirot_values[9] != 10 else "(条件一致: 10)"}
■ 運勢評価 (1-5):
金・資産運: {fortune_points['金・資産運']}
仕事・名声運: {fortune_points['仕事・名声運']}
家庭運: {fortune_points['家庭運']}
人間関係・恋愛運: {fortune_points['人間関係・恋愛運']}
成長運: {fortune_points['成長運']}
競争運: {fortune_points['競争運']}
健康運: {fortune_points['健康運']}
■ 性格分析:
{personality}
■ ラッキーカラー:
{destiny_color} - {destiny_meaning}
============================================================
        """
        return report
        
    except Exception as e:
        import traceback
        error_msg = f"""エラー発生: {str(e)}
{traceback.format_exc()}"""
        return error_msg

# ---
# 実行例（815:石破茂氏）
hebrew_name = "שִׁגֶרֻ יִשִׁבָ"
gregorian_date = "1957-02-04"
report = kabala_numerology_analysis(gregorian_date, hebrew_name)
print(report)

# ---
# 実行例（366:安倍晋三)
hebrew_name = "שִׁנְזֹו אָבֶ"
gregorian_date = "1954-09-21"
# ---
report = kabala_numerology_analysis(gregorian_date, hebrew_name)
print(report)

```

D先生： “それでは、いよいよ結果を見てみましょう。”

============================================================

カバラ数秘術占いプログラム (仕様変更版)

============================================================

- ヘブライ語氏名: שִׁגֶרֻ יִשִׁבָ
- グレゴリオ生年月日: 1957-02-04
- ユダヤ歴生年月日: 717年 12月 3日

============================================================

■ 基本数値:

- 運命数: 3
- 表現数: 4 
- 魂の欲求数: 0 
- 人格数: 4 

■ 生命の樹セフィラ値 (仕様変更後):

1. ケテル (王冠): 3 (運命数)
2. ホクマー (知恵): 3 (誕生日の還元数)
3. ビナー (理解): 3 (条件一致: 3)
4. チェセド (慈悲): 4 (条件一致: 4)
5. ゲヴラ (厳厲): 4 (表現数の還元数)
6. ティファアレト (美): 7 (運命数+表現数の還元数)
7. ネツァフ (勝利): 0 (魂の欲求数の還元数)
8. ホド (威光): 3 (運命数の還元数)
9. イェソド (基礎): 3 (運命数の還元数)
10. マルクト (王国): 7 (運命数+表現数+魂の欲求数の還元数)

■ 運勢評価 (1-5):
- 金・資産運: 2.8
- 仕事・名声運: 3.6
- 家庭運: 2.3
- 人間関係・恋愛運: 3.4
- 成長運: 4.3
- 競争運: 2.2
- 健康運: 1.2

■ 性格分析:

創造性と表現力豊かな芸術家タイプ。社交的で周囲を楽しませる才能があります。

■ ラッキーカラー:

黄 - 表現・喜び

============================================================

QEU:FOUNDER ： “かなり成長運が高くでます。前回と同じでしょう？”

D先生： “じゃあ、次の方は？”

============================================================

カバラ数秘術占いプログラム (仕様変更版)

============================================================

- ヘブライ語氏名: שִׁנְזֹו אָבֶ
- グレゴリオ生年月日: 1954-09-21
- ユダヤ歴生年月日: 714年 6月 23日

============================================================

■ 基本数値:

- 運命数: 5
- 表現数: 8
- 魂の欲求数: 0
- 人格数: 8 

■ 生命の樹セフィラ値 (仕様変更後):

1. ケテル (王冠): 5 (運命数)
2. ホクマー (知恵): 5 (誕生日の還元数)
3. ビナー (理解): 6 (誕生月の還元数)
4. チェセド (慈悲): 3 (誕生年の還元数)
5. ゲヴラ (厳厲): 8 (表現数の還元数)
6. ティファアレト (美): 4 (運命数+表現数の還元数)
7. ネツァフ (勝利): 0 (魂の欲求数の還元数)
8. ホド (威光): 8 (条件一致: 8)
9. イェソド (基礎): 5 (運命数の還元数)
10. マルクト (王国): 4 (運命数+表現数+魂の欲求数の還元数)

■ 運勢評価 (1-5):

- 金・資産運: 3.1
- 仕事・名声運: 3.4
- 家庭運: 1.8
- 人間関係・恋愛運: 1.3
- 成長運: 3.1
- 競争運: 4.3
- 健康運: 1.7

■ 性格分析:

自由と変化を愛する冒険家。適応力が高く、多様な経験を求めます。

■ ラッキーカラー:

青 - 自由・変革

============================================================

D先生： “この方の競争運は強く出てきます。前回と似た結論になるのは、なぜだろう・・・。”

QEU:FOUNDER ： “謎です・・・（笑）。”

D先生： “結局、この値は、EXCELファイルのポイント表次第でしょ？どうやって作ったんですか？ “

QEU:FOUNDER  ： “細かく言うときりがないので、これ以上の説明はしません。自分のアイデアと信念で作ってみればいいのではないでしょうか。この手のテーブルは、晒したとしても、第三者は絶対に納得いかないはずですから・・・。”

D先生： “実は納得はしませんが、なるほど・・・。次は、いったい何をしますか？ “

QEU:FOUNDER  ： “ちょっと、立ち止まって進め方を考えます。このロジックが他の占いと融合できる状態に来ているかどうかを・・・。”


## ～ まとめ ～

QEU:FOUNDER ： “とうとう、地味にスゴイLLMが出来て来たようです。小生には、あまりなじみはないが・・・。”

![imageINDS2-33-7](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-7.jpg) 

C部長：“QWENとDEEPSEEKを使っているからでしょ？さらに、最近QWENが良化して、喜んでいるとか・・・。”

![imageINDS2-33-8](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-8.jpg) 

QEU:FOUNDER ： “コストが違うからね。5分の1ぐらいになっているんじゃないか？とてもじゃないが、小生としては乗り換えることができません。さて、**「乗る」**といういみでは、このイノベーション（↑）があります。”

C部長：“あっ！K国が、もうアレを導入しているんだ！！”

[![MOVIE1](http://img.youtube.com/vi/z7ziwMYZnyE/0.jpg)](http://www.youtube.com/watch?v=z7ziwMYZnyE "First autonomous village bus launched in Seoul")

QEU:FOUNDER ： “すごいなあ・・・。**先進国は違いますね**。”

![imageINDS2-33-9](/2025-08-10-QEUR23_INDHS33/imageINDS2-33-9.jpg) 

C部長：”んだんだ・・・。”
