---
title: QEUR23_INDHS29 - 閑話休題～紫微斗数をやってみる(カップル版最終) 
date: 2025-08-03
tags: ["QEUシステム", "メトリックス", "Python言語", "Unsloth", "LLM", "データセット", "BONSAI", "LangGraph"]
excerpt: あたらしいLLMの学習体系を確立する
---

## QEUR23_INDHS29 - 閑話休題～紫微斗数をやってみる(カップル版最終)  

## ～  はぁ・・、「Aさん」に同情するなあ ～

QEU:FOUNDER ： “三分割（前半、中間、最終）の最終プログラムにきました。まずは、前半プログラムのアウトプットから見てみます。”

![imageINDS1-20-1](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-1.jpg) 

D先生： “今回のネタは、この写真（↓）で幸せそうに笑っている**「カップル」**でした・・・（笑）。中間で、このカップルを占ってみると？”

![imageINDS1-20-2](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-2.jpg) 

QEU:FOUNDER ： “職業適性のこと？”

![imageINDS1-20-3](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-3.jpg) 

D先生： “いえいえ・・・。例の、我々を感動させた**「流年情報」のこと**です・・・。 “

![imageINDS1-20-4](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-4.jpg) 

D先生： “あれ？流年情報が前回のプログラムよりも多くなりました。 “

QEU:FOUNDER  ： “当初の予定よりも複雑なことを占うことになりました。”

D先生：“改造した中間プログラムは、晒さないの？”

QEU:FOUNDER ： “やめた。前回と比較にならないくらい複雑になります。さっきアウトプットを紹介したので、その情報を使って、自分でVibe Codingができます。それでは、いきなりですが、今回の最終プログラムをドン！！これは長いよ！覚悟して！！”

```python
# ----
# -*- coding: utf-8 -*-
"""
紫微斗数最終処理プログラム
中間結果を最終結果に変換し、流年情報を基にした詳細分析を行う
"""
import datetime
import pandas as pd
import json
from typing import Dict, List, Tuple, Any
import numpy as np
import japanize_matplotlib
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import os
import re
import shutil
from lunarcalendar import Converter, Solar, Lunar
import traceback
import openpyxl
from openpyxl.styles import Border, Side, Font, Alignment, PatternFill
from openpyxl.utils import get_column_letter
from langchain_core.prompts import ChatPromptTemplate, SystemMessagePromptTemplate, Hu-manMessagePromptTemplate
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import JsonOutputParser
import sys
class ZiWeiDouShuFinal:
    """紫微斗数最終処理クラス（改善版）"""
    def __init__(self):
        """初期化処理"""
        print("INFO: Initializing ZiWeiDouShuFinal...")
        # 108星の分類
        self.main_stars = ["紫微", "天機", "太陽", "武曲", "天同", "廉貞",
                          "天府", "太陰", "貪狼", "巨門", "天相", "天梁",
                          "七殺", "破軍"]
        self.auxiliary_stars = ["文昌", "文曲", "左輔", "右弼", "天魁", "天鉞",
                               "禄存", "天馬", "化禄", "化権", "化科", "化忌"]
        self.inauspicious_stars = ["火星", "鈴星", "擎羊", "陀羅", "天刑", "天姚",
                                 "天哭", "天虚", "孤辰", "寡宿", "破碎", "蜚廉"]
        self.other_stars = ["龍池", "鳳閣", "紅鸞", "天喜", "華蓋", "咸池", "天徳",
                          "月徳", "解神", "天巫", "天月", "陰煞", "台輔", "封誥",
                          "天空", "截空", "三台", "八座", "恩光", "天貴", "天官",
                          "天福", "天厨", "天印", "天帥", "天赦", "天朽", "天傷",
                          "博士", "力士", "青龍", "小耗", "將軍", "奏書", "飛廉",
                          "喜神", "病符", "大耗", "伏兵", "官府", "歳建", "晦気",
                          "喪門", "貫索", "官符", "小耗", "大耗", "龍徳", "白虎",
                          "天狗", "吊客", "病符", "息神", "災煞", "劫煞", "天煞",
                          "指背", "咸池", "月煞", "亡神"]
        # 12宮の定義（奴僕宮を交友宮に統一）
        self.palaces = ["命宮", "兄弟宮", "夫妻宮", "子女宮", "財帛宮", "疾厄宮",
                       "遷移宮", "交友宮", "官禄宮", "田宅宮", "福徳宮", "父母宮"]
        # 地支の定義
        self.di_zhi = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]
        # 天干の定義
        self.tian_gan = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
        # 四化星のルール
        self.four_transformations = {
            "甲": ["廉貞化禄", "破軍化権", "武曲化科", "太陽化忌"],
            "乙": ["天機化禄", "天梁化権", "紫微化科", "太陰化忌"],
            "丙": ["天同化禄", "天機化権", "文昌化科", "廉貞化忌"],
            "丁": ["太陰化禄", "天同化権", "天機化科", "巨門化忌"],
            "戊": ["貪狼化禄", "太陰化権", "右弼化科", "天機化忌"],
            "己": ["武曲化禄", "貪狼化権", "天梁化科", "文曲化忌"],
            "庚": ["太陽化禄", "武曲化権", "太陰化科", "天同化忌"],
            "辛": ["巨門化禄", "太陽化権", "文曲化科", "文昌化忌"],
            "壬": ["天梁化禄", "紫微化権", "左輔化科", "武曲化忌"],
            "癸": ["破軍化禄", "巨門化権", "太陰化科", "貪狼化忌"]
        }
        # 天干の数値マッピング（要件定義に基づく）
        self.tian_gan_values = {
            "甲": 1, "己": 1,
            "乙": 2, "庚": 2,
            "丙": 3, "辛": 3,
            "丁": 4, "壬": 4,
            "戊": 5, "癸": 5
        }
        # 地支の数値マッピング（要件定義に基づく）
        self.di_zhi_values = {
            "子": 1, "午": 1,
            "丑": 2, "未": 2,
            "寅": 3, "申": 3,
            "卯": 4, "酉": 4,
            "辰": 5, "戌": 5,
            "巳": 6, "亥": 6
        }
        # 日本語フォント設定
        self.japanese_font = self._configure_japanese_font()
        print("SUCCESS: ZiWeiDouShuFinal initialized successfully")
    def _configure_japanese_font(self):
        """日本語フォントを自動検出して設定する"""
        print("INFO: Configuring Japanese font for matplotlib...")
        # 優先順位の高い日本語フォントリスト
        preferred_fonts = ['Noto Sans CJK JP', 'Noto Serif CJK JP', 'Hiragino Sans',
                          'Hiragino Kaku Gothic Pro', 'Meiryo', 'MS Gothic', 'IPAexGothic']
        available_fonts = set([f.name for f in fm.fontManager.ttflist])
        for font in preferred_fonts:
            if font in available_fonts:
                plt.rcParams['font.family'] = font
                print(f"SUCCESS: Japanese font set to '{font}'")
                return font
        # フォントが見つからない場合のフォールバック
        print("WARNING: No preferred Japanese font found. Trying system default...")
        plt.rcParams['font.family'] = 'sans-serif'
        plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'SimHei', 'Microsoft YaHei']
        return 'sans-serif'
    def _normalize_palace_name(self, palace: str) -> str:
        """宮位名を正規化（漢字の違い、スペース対応）"""
        if not palace:
            return palace
        # 漢字の正規化（"徳"と"德"の統一など）
        palace = palace.replace("徳", "德").replace(" ", "").strip()
        # 類似名称のマッピング（奴僕宮を交友宮に統一）
        palace_mapping = {
            "福德宮": "福徳宮",
            "福徳": "福徳宮",
            "福德": "福徳宮",
            "福德宮位": "福徳宮",
            "福徳宮位": "福徳宮",
            "兄弟": "兄弟宮",
            "夫妻": "夫妻宮",
            "子女": "子女宮",
            "財帛": "財帛宮",
            "疾厄": "疾厄宮",
            "遷移": "遷移宮",
            "奴僕": "交友宮",  # 奴僕宮を交友宮に統一
            "交友": "交友宮",   # 交友宮の別名
            "官禄": "官禄宮",
            "田宅": "田宅宮",
            "父母": "父母宮",
            "奴僕宮": "交友宮"  # 奴僕宮を交友宮に変換
        }
        return palace_mapping.get(palace, palace)
    def _load_palace_stars_from_sheet(self, excel_file: str, sheet_name: str) -> Dict:
        """命盤シートから12宮の星配置を読み込む"""
        print(f"INFO: Loading palace stars from sheet: {sheet_name}")
        try:
            wb = openpyxl.load_workbook(excel_file)
            if sheet_name not in wb.sheetnames:
                raise ValueError(f"命盤シート '{sheet_name}' が見つかりません。利用可能なシート: {wb.sheetnames}")
            sheet = wb[sheet_name]
            palace_stars = {}
            # ヘッダー行をスキップしてデータ行を処理
            for row in sheet.iter_rows(min_row=2, values_only=True):
                if row[0] is None:
                    continue
                palace = self._normalize_palace_name(str(row[0]))
                if not palace:
                    continue
                # 星情報を処理
                stars = []
                if row[1] and str(row[1]).strip() != "nan":
                    stars.extend([s.strip() for s in str(row[1]).split(",") if s.strip()])
                if row[2] and str(row[2]).strip() != "nan":
                    stars.extend([s.strip() for s in str(row[2]).split(",") if s.strip()])
                if row[3] and str(row[3]).strip() != "nan":
                    stars.extend([s.strip() for s in str(row[3]).split(",") if s.strip()])
                if row[4] and str(row[4]).strip() != "nan":
                    stars.extend([s.strip() for s in str(row[4]).split(",") if s.strip()])
                # 空の値を除外
                stars = [s for s in stars if s and s != "nan"]
                palace_stars[palace] = stars
            # 必要な宮位が存在しない場合の補完
            for palace in self.palaces:
                normalized_palace = self._normalize_palace_name(palace)
                if normalized_palace not in palace_stars:
                    similar_palace = self._find_similar_palace(normalized_palace, palace_stars)
                    if similar_palace:
                        palace_stars[normalized_palace] = palace_stars[similar_palace]
                    else:
                        print(f"WARNING: Palace '{palace}' not found. This may affect analysis accuracy.")
                        palace_stars[normalized_palace] = []
            print(f"SUCCESS: Palace stars loaded from sheet '{sheet_name}'")
            return palace_stars
        except Exception as e:
            print(f"ERROR: Failed to load palace stars from sheet '{sheet_name}': {str(e)}")
            raise
    def _find_similar_palace(self, palace: str, palace_stars: Dict) -> str:
        """類似する宮位名を検索"""
        for p in palace_stars.keys():
            if p in palace or palace in p:
                return p
        return None
    def _load_chart_from_sheet(self, excel_file: str, sheet_name: str) -> Dict:
        """基本情報シートから個人情報を抽出"""
        print(f"INFO: Loading chart data from sheet: {sheet_name}")
        try:
            wb = openpyxl.load_workbook(excel_file, read_only=True)
            if sheet_name not in wb.sheetnames:
                raise ValueError(f"情報シート '{sheet_name}' が見つかりません。利用可能なシート: {wb.sheetnames}")
            sheet = wb[sheet_name]
            person_info = {
                "name": "",
                "birth_info": {
                    "year": "",
                    "month": "",
                    "day": "",
                    "hour": "",
                    "minute": "",
                    "place": "",
                    "gender": "",
                    "solar_date": "",
                    "lunar_date": "",
                    "year_gz": "",
                    "month_gz": ""
                },
                "five_elements": "",
                "life_palace": "",
                "body_palace": "",
                "gender": ""
            }
            # シートのデータを読み込む
            for row in sheet.iter_rows(min_row=2, values_only=True):
                if row[0] is None or row[1] is None:
                    continue
                key = str(row[0]).strip()
                value = row[1]
                if key == "名前":
                    person_info["name"] = str(value)
                elif key == "生年月日":
                    if "年" in str(value):
                        parts = re.split(r'[年月日]', str(value))
                        if len(parts) >= 4:
                            person_info["birth_info"]["year"] = parts[0]
                            person_info["birth_info"]["month"] = parts[1]
                            person_info["birth_info"]["day"] = parts[2]
                elif key == "出生時間":
                    if "時" in str(value):
                        parts = re.split(r'[時分]', str(value))
                        if len(parts) >= 2:
                            person_info["birth_info"]["hour"] = parts[0]
                            person_info["birth_info"]["minute"] = parts[1]
                elif key == "出生地":
                    person_info["birth_info"]["place"] = str(value)
                elif key == "性別":
                    person_info["birth_info"]["gender"] = str(value)
                    person_info["gender"] = str(value)
                elif key == "真太陽時":
                    person_info["birth_info"]["solar_date"] = str(value)
                elif key == "旧暦":
                    person_info["birth_info"]["lunar_date"] = str(value)
                elif key == "年干支":
                    person_info["birth_info"]["year_gz"] = str(value)
                elif key == "月干支":
                    person_info["birth_info"]["month_gz"] = str(value)
                elif key == "五行局":
                    person_info["five_elements"] = str(value)
                elif key == "命宮":
                    # 宮位名の正規化
                    person_info["life_palace"] = self._normalize_palace_name(str(value)).replace("宮", "")
                elif key == "身宮":
                    # 宮位名の正規化
                    person_info["body_palace"] = self._normalize_palace_name(str(value)).replace("宮", "")
                elif key == "性別":
                    person_info["gender"] = value
            # 必須項目の検証
            required_fields = {
                "name": "ユーザー名がありません。分析を続行できません。",
                "life_palace": "命宮情報がありません。分析を続行できません。"
            }
            for field, error_msg in required_fields.items():
                if not person_info.get(field):
                    print(f"ERROR: {error_msg}")
                    raise ValueError(error_msg)
            print(f"SUCCESS: Chart data loaded from sheet '{sheet_name}' for {person_info['name']}")
            return person_info
        except Exception as e:
            print(f"ERROR: Failed to load chart from sheet '{sheet_name}': {str(e)}")
            raise
            
    def create_fortune_prompt(self, relationship: str) -> Tuple[ChatPromptTemplate, JsonOutput-Parser]:
        """年運分析プロンプトを作成（関係性判定ロジック修正版）"""
        print("INFO: Creating fortune analysis prompt...")
        # 関係性キーワードと指示文のマッピング
        relationship_instructions = {
            "上司": "紫微斗数の正統な手順と考え方に基づき、上司との仕事上の相性、上司が自身の成長の妨げになっていないかについて以下のJSON形式で結果を出力してください。",
            "同僚": "紫微斗数の正統な手順と考え方に基づき、同僚との仕事のスタイルや性格の相性、潜在的な競争関係について以下のJSON形式で結果を出力してください。",
            "友人": "紫微斗数の正統な手順と考え方に基づき、友人との興味の共有や利害関係について以下のJSON形式で結果を出力してください。",
            "異性": "紫微斗数の正統な手順と考え方に基づき、異性との興味の共有や愛情の維持、他の人との競争関係について以下のJSON形式で結果を出力してください。"
        }
        # 関係性文字列からキーワードを検出
        instruction = "紫微斗数の正統な手順と考え方に基づき、以下のJSON形式で結果を出力してください。"
        for keyword, custom_instruction in relationship_instructions.items():
            if keyword in relationship:
                instruction = custom_instruction
                print(f"DEBUG: Using custom instruction for '{keyword}'")
                break
        system_template = """あなたは優秀な紫微斗数専門家です。以下の情報を基に、JSON形式で詳細な占い結果を出力してください。"""
        human_template = """### ユーザー情報:
名前: {name}
生年月日: {birth_year}年{month}月{day}日 {hour}時{minute}分
出生地: {place}
性別: {gender}
五行局: {five_elements}
命宮: {life_palace}宮
身宮: {shen_gong}宮

### 命盤情報:
命宮: {ming_gong_stars}
兄弟宮: {xiong_di_gong_stars}
夫妻宮: {fu_qi_gong_stars}
子女宮: {zi_nu_gong_stars}
財帛宮: {cai_bo_gong_stars}
疾厄宮: {ji_e_gong_stars}
遷移宮: {qian_yi_gong_stars}
交友宮: {jiao_you_gong_stars}
官禄宮: {guan_lu_gong_stars}
田宅宮: {tian_zhai_gong_stars}
福徳宮: {fu_de_gong_stars}
父母宮: {fu_mu_gong_stars}

### ★{year}年の特異的な運勢情報★
※この年の運勢を決定づける重要な要素※
干支: {gan_zhi}
大限: {major_period}
小限: {minor_period}
四化星: {four_transform_stars}
流曜: {annual_stars}

### 流年各宮の星配置（{year}年特有の配置）:
流年財帛宮: {cai_bo_annual}
流年交友宮: {jiao_you_annual}
流年兄弟宮: {xiong_di_annual}
流年疾厄宮: {ji_e_annual}
流年官禄宮: {guan_lu_annual}
流年命宮: {ming_annual}
流年父母宮: {fu_mu_annual}
流年子女宮: {zi_nu_annual}
流年夫妻宮: {fu_qi_annual}
流年遷移宮: {qian_yi_annual}

### 指示:
{instruction}

### スコア評価の重要ポイント:
1. 四化星・流曜の影響を特に考慮すること
2. 流年宮位の星配置変化を反映すること
3. 大限・小限の変化を考慮すること

### スコア評価基準:
- お金スコア(money):
  [+] その年特有の収入増加・投資利益
  [-] その年特有の支出増・経済的損失
  
- 人間関係スコア(relation):
  [+] その年に形成された新規関係・関係深化
  [-] その年に生じた関係悪化・孤立
  
- 健康スコア(health):
  [+] その年の健康改善・体力向上
  [-] その年に発生した病気・怪我
  
- 事業スコア(business):
  [+] その年の事業成長・キャリアアップ
  [-] その年の事業挫折・キャリアダウン
  
- 成長スコア(growth):
  [+] その年に獲得した新たなスキル・知識
  [-] その年の成長機会損失
  
- 家庭スコア(family):
  [+] その年の家庭内関係改善・慶事
  [-] その年の家庭内問題・悲事
  
- 競争スコア(competition):
  [+] その年特有の競争優位性
  [-] その年特有の競争劣位性）

### JSON形式:
{{
    "evaluation": {{
        "year": {year},
        "money": {{
            "score": "範囲は-5から5",
            "reason": "流年財帛宮の星配置などに基づく根拠"
        }},
        "relation": {{
            "score": "範囲は-5から5",
            "reason": "流年交友宮・兄弟宮の星配置などに基づく根拠"
        }},
        "health": {{
            "score": "範囲は-5から5",
            "reason": "流年疾厄宮の星配置などに基づく根拠"
        }},
        "business": {{
            "score": "範囲は-5から5",
            "reason": "流年官禄宮の星配置などに基づく根拠"
        }},
        "growth": {{
            "score": "範囲は-5から5",
            "reason": "流年命宮・父母宮・官禄宮などに基づく根拠"
        }},
        "family": {{
            "score": "範囲は-5から5",
            "reason": "流年兄弟宮・子女宮・夫妻宮・父母宮などに基づく根拠"
        }},
        "competition": {{
            "score": "範囲は-5から5",
            "reason": "流年命宮・遷移宮・交友宮などに基づく根拠"
        }},
    }},
    "yearly_comment": "四化星・流曜配置の意味などから総合的に解釈する（100-150文字）",
    "fortune_summary": "年間総合運勢（350-400文字）"
}}"""        
        system_message_prompt = SystemMessagePromptTemplate.from_template(system_template)
        human_message_prompt = HumanMessagePromptTemplate.from_template(human_template)
        prompt = ChatPromptTemplate.from_messages([
            system_message_prompt,
            human_message_prompt
        ])
        # JSON出力のパーサーを作成
        output_parser = JsonOutputParser()
        print("SUCCESS: Fortune analysis prompt created")
        return prompt, output_parser, instruction    
    
    def analyze_fortune(self, user_info: Dict, palace_stars: Dict, fortune_data: Dict, relationship: str) -> Dict:
        """年運分析を実行（改善版）"""
        print(f"INFO: Analyzing fortune for {fortune_data['year']}...")
        try:
            llm = ChatOpenAI(
                model="deepseek-chat",
                api_key=os.getenv("DEEPSEEK_API_KEY"),
                base_url="https://api.deepseek.com",
                temperature=0.7
            )            
            # プロンプトの作成 (関係性を含む)
            prompt, output_parser, instruction = self.create_fortune_prompt(relationship)
            # 命盤情報をフォーマット
            formatted_stars = {}
            for palace in self.palaces:
                normalized_palace = self._normalize_palace_name(palace)
                stars = palace_stars.get(normalized_palace, [])
                formatted_stars[normalized_palace] = ", ".join(stars) if stars else "なし"
            input_data = {
                "name": user_info["name"],
                "birth_year": user_info["birth_info"]["year"],
                "month": user_info["birth_info"]["month"],
                "day": user_info["birth_info"]["day"],
                "hour": user_info["birth_info"]["hour"],
                "minute": user_info["birth_info"]["minute"],
                "place": user_info["birth_info"]["place"],
                "gender": user_info["gender"],
                "five_elements": user_info["five_elements"],
                "life_palace": user_info["life_palace"],
                "shen_gong": user_info["body_palace"],
                "ming_gong_stars": formatted_stars["命宮"],
                "xiong_di_gong_stars": formatted_stars["兄弟宮"],
                "fu_qi_gong_stars": formatted_stars["夫妻宮"],
                "zi_nu_gong_stars": formatted_stars["子女宮"],
                "cai_bo_gong_stars": formatted_stars["財帛宮"],
                "ji_e_gong_stars": formatted_stars["疾厄宮"],
                "qian_yi_gong_stars": formatted_stars["遷移宮"],
                "jiao_you_gong_stars": formatted_stars["交友宮"],
                "guan_lu_gong_stars": formatted_stars["官禄宮"],
                "tian_zhai_gong_stars": formatted_stars["田宅宮"],
                "fu_de_gong_stars": formatted_stars["福徳宮"],
                "fu_mu_gong_stars": formatted_stars["父母宮"],
                "year": fortune_data["year"],  # キー変更
                "gan_zhi": fortune_data["annual_gz"],  # キー変更
                "major_period": fortune_data["major_period"],
                "minor_period": fortune_data["minor_period"],
                "four_transform_stars": ", ".join(fortune_data["four_transform_stars"]),
                "annual_stars": ", ".join(fortune_data["annual_stars"]),
                "cai_bo_annual": fortune_data["cai_bo_annual"],
                "jiao_you_annual": fortune_data["jiao_you_annual"],
                "xiong_di_annual": fortune_data["xiong_di_annual"],
                "ji_e_annual": fortune_data["ji_e_annual"],
                "guan_lu_annual": fortune_data["guan_lu_annual"],
                "ming_annual": fortune_data["ming_annual"],
                "fu_mu_annual": fortune_data["fu_mu_annual"],
                "zi_nu_annual": fortune_data["zi_nu_annual"],
                "fu_qi_annual": fortune_data["fu_qi_annual"],
                "qian_yi_annual": fortune_data["qian_yi_annual"],
                "instruction": instruction  # 追加
            }            
            # プロンプトの実行
            chain = prompt | llm | output_parser
            result = chain.invoke(input_data)
            print(f"SUCCESS: Fortune analysis completed for {fortune_data['year']}")
            return result
        except Exception as e:
            print(f"ERROR: Fortune analysis failed for {fortune_data['year']}: {str(e)}")
            raise
    def export_to_excel(self, fortune_list: List[Dict], fortune_results: List[Dict], 
                       user_info: Dict, excel_file: str, prefix: str = ""):
        """分析結果をExcelに出力（スコア取得ロジック修正版）"""
        print("INFO: Starting to export score results to Excel...")
        try:
            # スタイルの定義を追加
            thin_border = Border(left=Side(style='thin'), 
                                right=Side(style='thin'),
                                top=Side(style='thin'),
                                bottom=Side(style='thin'))
            wrap_alignment = Alignment(wrap_text=True, vertical='top')
            header_font = Font(bold=True)
            header_fill = PatternFill(start_color="DDEBF7", end_color="DDEBF7", fill_type="solid")

            wb = openpyxl.load_workbook(excel_file)
            score_sheet_name = f"{prefix}年別運勢スコア"

            if score_sheet_name in wb.sheetnames:
                del wb[score_sheet_name]
            score_sheet = wb.create_sheet(title=score_sheet_name)

            headers = [
                "年", "大限", "小限", "干支", "流曜", "流年四化星",
                "お金", "人間関係", "健康", "事業", "成長", "家庭", "競争",
                "年間コメント", "運勢"
            ]
            score_sheet.append(headers)

            # ヘッダーのスタイル設定
            for col in range(1, len(headers)+1):
                cell = score_sheet.cell(row=1, column=col)
                cell.border = thin_border
                cell.font = header_font
                cell.fill = header_fill

            # データ追加
            for fortune_data, result in zip(fortune_list, fortune_results):
                evaluation = result["evaluation"]

                # スコア取得方法を修正（直接resultから取得）
                money_score = evaluation['money']['score']
                relation_score = evaluation['relation']['score']
                health_score = evaluation['health']['score']
                business_score = evaluation['business']['score']
                growth_score = evaluation['growth']['score']
                family_score = evaluation['family']['score']
                competition_score = evaluation['competition']['score']

                score_sheet.append([
                    fortune_data["year"],
                    fortune_data["major_period"],
                    fortune_data["minor_period"],
                    fortune_data["annual_gz"],
                    ", ".join(fortune_data["annual_stars"]),
                    ", ".join(fortune_data["four_transform_stars"]),
                    money_score,
                    relation_score,
                    health_score,
                    business_score,
                    growth_score,
                    family_score,
                    competition_score,
                    result["yearly_comment"],
                    result["fortune_summary"]
                ])

            # 書式設定
            for row in score_sheet.iter_rows(min_row=2, max_row=score_sheet.max_row):
                for cell in row:
                    cell.border = thin_border
                    # 評価列（7列目から13列目）は中央揃え
                    if cell.column >= 7 and cell.column <= 13:
                        cell.alignment = Alignment(horizontal='center')
                    # コメント列（14列目以降）は折り返し
                    if cell.column >= 14:
                        cell.alignment = wrap_alignment

            # 列幅の自動調整
            for col in range(1, score_sheet.max_column + 1):
                max_length = 0
                column = get_column_letter(col)
                for cell in score_sheet[column]:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = (max_length + 2)
                # 14列目以降は幅を広く取る
                if col >= 14:
                    adjusted_width = min(adjusted_width * 1.5, 50)
                score_sheet.column_dimensions[column].width = adjusted_width

            # ファイルを保存
            wb.save(excel_file)
            print(f"SUCCESS: Score results exported to Excel: {excel_file}")
            return excel_file
        except Exception as e:
            print(f"ERROR: Excel export failed: {str(e)}")
            traceback.print_exc()
            raise
        
    def export_relationship_sheet(self, user_fortune_list: List[Dict], user_fortune_results: List[Dict],
                                 partner_fortune_list: List[Dict], partner_fortune_results: List[Dict],
                                 user_info: Dict, partner_info: Dict, excel_file: str):
        """関係性シートをExcelに出力（データ形式改善版）"""
        print("INFO: Starting to export relationship sheet to Excel...")
        try:
            wb = openpyxl.load_workbook(excel_file)
            relationship_sheet_name = "関係性_年別運勢スコア"
            
            if relationship_sheet_name in wb.sheetnames:
                del wb[relationship_sheet_name]
            relationship_sheet = wb.create_sheet(title=relationship_sheet_name)

            headers = [
                "年", "大限", "小限", "干支", "流曜", "流年四化星",
                "お金", "人間関係", "健康", "事業", "成長", "家庭", "競争",
                "年間コメント", "運勢"
            ]
            relationship_sheet.append(headers)
            # セルのスタイル定義
            thin_border = Border(left=Side(style='thin'), 
                                right=Side(style='thin'),
                                top=Side(style='thin'),
                                bottom=Side(style='thin'))
            header_font = Font(bold=True)
            header_fill = PatternFill(start_color="DDEBF7", end_color="DDEBF7", fill_type="solid")
            wrap_alignment = Alignment(wrap_text=True)
            # ヘッダーの書式設定
            for col in range(1, len(headers)+1):
                cell = relationship_sheet.cell(row=1, column=col)
                cell.border = thin_border
                cell.font = header_font
                cell.fill = header_fill
            # ユーザーとパートナーの共通の年を抽出
            user_years = [f["year"] for f in user_fortune_list]
            partner_years = [f["year"] for f in partner_fortune_list]
            common_years = sorted(set(user_years) & set(partner_years))
            # データを追加
            for year in common_years:
                user_idx = user_years.index(year)
                user_data = user_fortune_list[user_idx]
                user_result = user_fortune_results[user_idx]
                user_evaluation = user_result["evaluation"]
                
                partner_idx = partner_years.index(year)
                partner_data = partner_fortune_list[partner_idx]
                partner_result = partner_fortune_results[partner_idx]
                partner_evaluation = partner_result["evaluation"]
                
                # 共通項目をUSER/PARTNER形式で作成（修正箇所）
                major_period_info = f"USER: {user_data['major_period']}\nPARTNER: {part-ner_data['major_period']}"
                minor_period_info = f"USER: {user_data['minor_period']}\nPARTNER: {part-ner_data['minor_period']}"
                gan_zhi_info = f"USER: {user_data['annual_gz']}\nPARTNER: {part-ner_data['annual_gz']}"
                annual_stars_info = f"USER: {', '.join(user_data['annual_stars'])}\nPARTNER: {', '.join(partner_data['annual_stars'])}"
                four_transform_info = f"USER: {', '.join(user_data['four_transform_stars'])}\nPARTNER: {', '.join(partner_data['four_transform_stars'])}"

                # スコア情報を統合（USER: ... PARTNER: ...形式）
                money_info = f"USER: {user_evaluation['money']['score']} ({us-er_evaluation['money']['reason']})\nPARTNER: {partner_evaluation['money']['score']} ({part-ner_evaluation['money']['reason']})"
                relation_info = f"USER: {user_evaluation['relation']['score']} ({us-er_evaluation['relation']['reason']})\nPARTNER: {partner_evaluation['relation']['score']} ({part-ner_evaluation['relation']['reason']})"
                health_info = f"USER: {user_evaluation['health']['score']} ({us-er_evaluation['health']['reason']})\nPARTNER: {partner_evaluation['health']['score']} ({part-ner_evaluation['health']['reason']})"
                business_info = f"USER: {user_evaluation['business']['score']} ({us-er_evaluation['business']['reason']})\nPARTNER: {partner_evaluation['business']['score']} ({part-ner_evaluation['business']['reason']})"
                growth_info = f"USER: {user_evaluation['growth']['score']} ({us-er_evaluation['growth']['reason']})\nPARTNER: {partner_evaluation['growth']['score']} ({part-ner_evaluation['growth']['reason']})"
                family_info = f"USER: {user_evaluation['family']['score']} ({us-er_evaluation['family']['reason']})\nPARTNER: {partner_evaluation['family']['score']} ({part-ner_evaluation['family']['reason']})"
                competition_info = f"USER: {user_evaluation['competition']['score']} ({us-er_evaluation['competition']['reason']})\nPARTNER: {partner_evaluation['competition']['score']} ({partner_evaluation['competition']['reason']})"
                # コメント情報を統合
                comment_info = f"【{user_info['name']}】\n{user_result['yearly_comment']}\n【{partner_info['name']}】\n{partner_result['yearly_comment']}"
                fortune_info = f"【{user_info['name']}】\n{user_result['fortune_summary']}\n【{partner_info['name']}】\n{partner_result['fortune_summary']}"
                # データを追加
                relationship_sheet.append([
                    year,
                    major_period_info,  # 修正: USER/PARTNER形式
                    minor_period_info,  # 修正: USER/PARTNER形式
                    gan_zhi_info,       # 修正: USER/PARTNER形式
                    annual_stars_info,  # 修正: USER/PARTNER形式
                    four_transform_info, # 修正: USER/PARTNER形式
                    money_info,
                    relation_info,
                    health_info,
                    business_info,
                    growth_info,
                    family_info,
                    competition_info,
                    comment_info,
                    fortune_info
                ])
            # 書式設定
            for row in relationship_sheet.iter_rows(min_row=2, max_row=relationship_sheet.max_row):
                for cell in row:
                    cell.border = thin_border
                    # 評価列（7列目から13列目）は中央揃え
                    if cell.column >= 7 and cell.column <= 13:
                        cell.alignment = Alignment(horizontal='center', vertical='top')
                    # コメント列（14列目以降）は折り返し
                    if cell.column >= 14:
                        cell.alignment = Alignment(wrap_text=True, vertical='top')
            # 列幅の自動調整
            for col in range(1, relationship_sheet.max_column + 1):
                max_length = 0
                column = get_column_letter(col)
                for cell in relationship_sheet[column]:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = (max_length + 2)
                # 7列目以降は幅を広く取る
                if col >= 7:
                    adjusted_width = min(adjusted_width * 1.2, 50)
                relationship_sheet.column_dimensions[column].width = adjusted_width
            # ファイルを保存
            wb.save(excel_file)
            print(f"SUCCESS: Relationship sheet exported to Excel: {excel_file}")
            return excel_file
        except Exception as e:
            print(f"ERROR: Relationship sheet export failed: {str(e)}")
            traceback.print_exc()
            raise
            
    def create_fortune_timeline_graph(self, user_fortune_results: List[Dict], partner_fortune_results: List[Dict], 
                                    user_info: Dict, partner_info: Dict, output_dir: str):
        """運勢の時系列グラフを作成"""
        print("INFO: Creating fortune timeline graphs...")
        try:
            os.makedirs(output_dir, exist_ok=True)
            # 分析結果が存在しない場合は終了
            if not user_fortune_results or not partner_fortune_results:
                print("WARNING: No fortune results to plot. Skipping graph creation.")
                return
            # ユーザーの運勢データを抽出
            user_years = [r["evaluation"]["year"] for r in user_fortune_results]
            user_money = [r["evaluation"]["money"]["score"] for r in user_fortune_results]
            user_relation = [r["evaluation"]["relation"]["score"] for r in user_fortune_results]
            user_health = [r["evaluation"]["health"]["score"] for r in user_fortune_results]
            user_business = [r["evaluation"]["business"]["score"] for r in user_fortune_results]
            user_growth = [r["evaluation"]["growth"]["score"] for r in user_fortune_results]
            user_family = [r["evaluation"]["family"]["score"] for r in user_fortune_results]
            user_competition = [r["evaluation"]["competition"]["score"] for r in user_fortune_results]
            # パートナーの運勢データを抽出
            partner_years = [r["evaluation"]["year"] for r in partner_fortune_results]
            partner_money = [r["evaluation"]["money"]["score"] for r in partner_fortune_results]
            partner_relation = [r["evaluation"]["relation"]["score"] for r in partner_fortune_results]
            partner_health = [r["evaluation"]["health"]["score"] for r in partner_fortune_results]
            partner_business = [r["evaluation"]["business"]["score"] for r in partner_fortune_results]
            partner_growth = [r["evaluation"]["growth"]["score"] for r in partner_fortune_results]
            partner_family = [r["evaluation"]["family"]["score"] for r in partner_fortune_results]
            partner_competition = [r["evaluation"]["competition"]["score"] for r in part-ner_fortune_results]
            # ---
            # ユーザー運勢グラフ（主要4項目）
            plt.figure(figsize=(15, 8))
            plt.plot(user_years, user_money, 'o-', label='金運', linewidth=2)
            plt.plot(user_years, user_relation, 's-', label='人間関係', linewidth=2)
            plt.plot(user_years, user_health, '^-', label='健康', linewidth=2)
            plt.plot(user_years, user_business, 'd-', label='事業', linewidth=2)

            plt.plot(user_years, user_growth, 'D-', label='成長', linewidth=2)
            plt.plot(user_years, user_family, '>-', label='家庭', linewidth=2)
            plt.plot(user_years, user_competition, 'v-', label='競争', linewidth=2)

            plt.title(f'{user_info["name"]}の運勢推移 ({min(user_years)}-{max(user_years)})', font-size=16)
            plt.xlabel('年', fontsize=14)
            plt.ylabel('評価スコア (-5～5)', fontsize=14)
            plt.grid(True, linestyle='--', alpha=0.7)
            plt.legend(fontsize=12, loc='upper left')
            plt.xticks(user_years, rotation=45)
            plt.ylim(-5.5, 5.5)
            user_graph_path = os.path.join(output_dir, f'{user_info["name"]}_fortune_timeline.png')
            plt.savefig(user_graph_path, bbox_inches='tight', dpi=300)
            plt.close()
            print(f"SUCCESS: User fortune timeline graph saved to {user_graph_path}")
            # ---
            # パートナー運勢グラフ（主要4項目）
            plt.figure(figsize=(15, 8))
            plt.plot(partner_years, partner_money, 'o-', label='金運', linewidth=2)
            plt.plot(partner_years, partner_relation, 's-', label='人間関係', linewidth=2)
            plt.plot(partner_years, partner_health, '^-', label='健康', linewidth=2)
            plt.plot(partner_years, partner_business, 'd-', label='事業', linewidth=2)

            plt.plot(partner_years, partner_growth, 'D-', label='成長', linewidth=2)
            plt.plot(partner_years, partner_family, '>-', label='家庭', linewidth=2)
            plt.plot(partner_years, partner_competition, 'v-', label='競争', linewidth=2)

            plt.title(f'{partner_info["name"]}の運勢推移 ({min(partner_years)}-{max(partner_years)})', fontsize=16)
            plt.xlabel('年', fontsize=14)
            plt.ylabel('評価スコア (-5～5)', fontsize=14)
            plt.grid(True, linestyle='--', alpha=0.7)
            plt.legend(fontsize=12, loc='upper left')
            plt.xticks(partner_years, rotation=45)
            plt.ylim(-5.5, 5.5)
            partner_graph_path = os.path.join(output_dir, f'{partner_info["name"]}_fortune_timeline.png')
            plt.savefig(partner_graph_path, bbox_inches='tight', dpi=300)
            plt.close()
            print(f"SUCCESS: Partner fortune timeline graph saved to {partner_graph_path}")
            # ---
            # 関係性_年別運勢スコアグラフ（すべての項目を表示）
            plt.figure(figsize=(15, 8))
            # 共通の年を取得
            common_years = sorted(set(user_years) & set(partner_years))
            if not common_years:
                print("WARNING: No common years found for relationship timeline graph.")
                return
            # 各指標の値を取得
            user_money_vals = [user_money[user_years.index(y)] for y in common_years]
            user_relation_vals = [user_relation[user_years.index(y)] for y in common_years]
            user_health_vals = [user_health[user_years.index(y)] for y in common_years]
            user_business_vals = [user_business[user_years.index(y)] for y in common_years]
            user_growth_vals = [user_growth[user_years.index(y)] for y in common_years]
            user_family_vals = [user_family[user_years.index(y)] for y in common_years]
            user_competition_vals = [user_competition[user_years.index(y)] for y in common_years]

            partner_money_vals = [partner_money[partner_years.index(y)] for y in common_years]
            partner_relation_vals = [partner_relation[partner_years.index(y)] for y in common_years]
            partner_health_vals = [partner_health[partner_years.index(y)] for y in common_years]
            partner_business_vals = [partner_business[partner_years.index(y)] for y in common_years]
            partner_growth_vals = [partner_growth[partner_years.index(y)] for y in common_years]
            partner_family_vals = [partner_family[partner_years.index(y)] for y in common_years]
            partner_competition_vals = [partner_competition[partner_years.index(y)] for y in com-mon_years]

            # パートナーのポイントを-0.2だけ移動
            partner_money_shifted = [p - 0.2 for p in partner_money_vals]
            partner_relation_shifted = [p - 0.2 for p in partner_relation_vals]
            partner_health_shifted = [p - 0.2 for p in partner_health_vals]
            partner_business_shifted = [p - 0.2 for p in partner_business_vals]
            partner_growth_shifted = [p - 0.2 for p in partner_growth_vals]
            partner_family_shifted = [p - 0.2 for p in partner_family_vals]
            partner_competition_shifted = [p - 0.2 for p in partner_competition_vals]

            # すべての指標をプロット
            plt.plot(common_years, user_money_vals, 'o-', label=f'{user_info["name"]} お金', lin-ewidth=2)
            plt.plot(common_years, user_relation_vals, 's-', label=f'{user_info["name"]} 人間関係', lin-ewidth=2)
            plt.plot(common_years, user_health_vals, '^-', label=f'{user_info["name"]} 健康', lin-ewidth=2)
            plt.plot(common_years, user_business_vals, 'd-', label=f'{user_info["name"]} 事業', lin-ewidth=2)
            plt.plot(common_years, user_growth_vals, 'D-', label=f'{user_info["name"]} 成長', lin-ewidth=2)
            plt.plot(common_years, user_family_vals, '>-', label=f'{user_info["name"]} 家庭', lin-ewidth=2)
            plt.plot(common_years, user_competition_vals, 'v-', label=f'{user_info["name"]} 競争', lin-ewidth=2)

            plt.plot(common_years, partner_money_shifted, 'o--', label=f'{partner_info["name"]} お金', linewidth=1)
            plt.plot(common_years, partner_relation_shifted, 's--', label=f'{partner_info["name"]} 人間関係', linewidth=1)
            plt.plot(common_years, partner_health_shifted, '^--', label=f'{partner_info["name"]} 健康', linewidth=1)
            plt.plot(common_years, partner_business_shifted, 'd--', label=f'{partner_info["name"]} 事業', linewidth=1)
            plt.plot(common_years, partner_growth_shifted, 'D--', label=f'{partner_info["name"]} 成長', linewidth=1)
            plt.plot(common_years, partner_family_shifted, '>--', label=f'{partner_info["name"]} 家庭', linewidth=1)
            plt.plot(common_years, partner_competition_shifted, 'v--', label=f'{partner_info["name"]} 競争', linewidth=1)

            plt.title(f'関係性_年別運勢スコア ({min(common_years)}-{max(common_years)})', font-size=16)
            plt.xlabel('年', fontsize=14)
            plt.ylabel('評価スコア (-5～5)', fontsize=14)
            plt.grid(True, linestyle='--', alpha=0.7)
            plt.legend(fontsize=8, ncol=2)
            plt.xticks(common_years, rotation=45)
            plt.ylim(-5.5, 5.5)
            relationship_graph_path = os.path.join(output_dir, 'relationship_timeline.png')
            plt.savefig(relationship_graph_path, bbox_inches='tight', dpi=300)
            plt.close()
            print(f"SUCCESS: Relationship timeline graph saved to {relationship_graph_path}")
        except Exception as e:
            print(f"ERROR: Failed to create fortune timeline graphs: {str(e)}")
            traceback.print_exc()
            raise

    def _parse_life_palace(self, life_palace: str) -> Tuple[str, str]:
        """命宮を天干と地支に分解"""
        # 命宮が干支（例: "甲子"）か地支のみ（例: "午"）かを判別
        if len(life_palace) >= 2:
            return life_palace[0], life_palace[1]
        else:
            return None, life_palace
    def calculate_major_period_start_age(self, life_palace: str) -> int:
        """大限開始年齢を計算"""
        # 命宮を天干と地支に分解
        gan, zhi = self._parse_life_palace(life_palace)
        # 天干の数値（天干がない場合は0）
        gan_value = self.tian_gan_values.get(gan, 0) if gan else 0
        # 地支の数値
        zhi_value = self.di_zhi_values.get(zhi, 0)
        # 合計を開始年齢とする
        return gan_value + zhi_value
    def process(self, excel_file: str, fortune_years: List[int] = None) -> str:
        """最終処理のメインメソッド（改善版）"""
        print("="*50)
        print("紫微斗数最終処理プログラムを開始します")
        print("="*50)
        try:
            # 1. 出力ファイル名を生成
            if "中間結果" in excel_file:
                output_file = excel_file.replace("中間結果", "最終結果")
            else:
                name, ext = os.path.splitext(excel_file)
                output_file = f"{name}_最終結果{ext}"
            
            # 元ファイルをコピー
            if excel_file != output_file:
                shutil.copy2(excel_file, output_file)
            
            # 2. ユーザー情報の読み込み
            print("STEP 1: Loading user information...")
            user_info = self._load_chart_from_sheet(output_file, "ユーザー基本情報")
            print(f"INFO: User loaded: {user_info['name']}")
            # 3. パートナー情報の検出と読み込み
            print("STEP 2: Detecting and loading partner information...")
            wb = openpyxl.load_workbook(output_file, read_only=True)
            partner_sheets = []
            for sheet_name in wb.sheetnames:
                if "パートナー" in sheet_name and "情報" in sheet_name:
                    partner_sheets.append(sheet_name)
            if not partner_sheets:
                raise ValueError("パートナー情報シートが見つかりません。シート名に'パートナー'と'情報'を含む必要があります。")
            # 最初のパートナー情報を読み込む
            partner_sheet_name = partner_sheets[0]
            partner_info = self._load_chart_from_sheet(output_file, partner_sheet_name)
            # 関係性をパートナー情報シート名から抽出
            relationship_match = re.search(r"パートナー\((.*?)\)情報", partner_sheet_name)
            if relationship_match:
                relationship = relationship_match.group(1)
            else:
                relationship = "パートナー"
                print(f"WARNING: Relationship not found in sheet name: {partner_sheet_name}. Using default.")
            print(f"INFO: Partner loaded: {partner_info['name']} ({relationship})")
            # 4. ユーザー命盤の読み込み
            print("STEP 3: Loading user natal chart...")
            user_chart = self._load_palace_stars_from_sheet(output_file, "ユーザー命盤")
            # 5. パートナー命盤の読み込み
            print("STEP 4: Loading partner natal chart...")
            # 関係性を含めた正しいシート名を生成
            partner_chart_name = f"パートナー({relationship})命盤"
            partner_chart = self._load_palace_stars_from_sheet(output_file, partner_chart_name)            
            # 6. 年別運勢シートの読み込み（中間結果から）
            print("STEP 5: Loading fortune year list from intermediate results...")
            # ユーザー年別運勢の読み込み
            user_fortune_sheet = "ユーザー_年別運勢"
            wb = openpyxl.load_workbook(output_file)
            user_fortune_list = []
            if user_fortune_sheet in wb.sheetnames:
                sheet = wb[user_fortune_sheet]
                for row in sheet.iter_rows(min_row=2, values_only=True):
                    if row[0] is None:
                        continue
                    year = int(row[0])
                    # fortune_yearsが指定されており、その年のデータが含まれていない場合はスキップ
                    if fortune_years is not None and year not in fortune_years:
                        continue
                    # Excelから直接必要な情報を読み込む（全流年情報を含む）
                    user_fortune_list.append({
                        "year": year,
                        "major_period": row[1],
                        "minor_period": row[2],
                        "annual_gz": row[3],  # 干支
                        "annual_stars": [s.strip() for s in str(row[4]).split(",")] if row[4] else [],  # 流曜
                        "four_transform_stars": [s.strip() for s in str(row[15]).split(",")] if row[15] else [],  # 流年四化星
                        # 追加の流年情報
                        "cai_bo_annual": str(row[5]).strip() if row[5] else "",   # 流年財帛宮
                        "jiao_you_annual": str(row[6]).strip() if row[6] else "", # 流年交友宮
                        "xiong_di_annual": str(row[7]).strip() if row[7] else "", # 流年兄弟宮
                        "ji_e_annual": str(row[8]).strip() if row[8] else "",     # 流年疾厄宮
                        "guan_lu_annual": str(row[9]).strip() if row[9] else "",  # 流年官禄宮
                        "ming_annual": str(row[10]).strip() if row[10] else "",   # 流年命宮
                        "fu_mu_annual": str(row[11]).strip() if row[11] else "",  # 流年父母宮
                        "zi_nu_annual": str(row[12]).strip() if row[12] else "",  # 流年子女宮
                        "fu_qi_annual": str(row[13]).strip() if row[13] else "",  # 流年夫妻宮
                        "qian_yi_annual": str(row[14]).strip() if row[14] else "" # 流年遷移宮
                    })
            else:
                raise ValueError(f"ユーザー年別運勢シート '{user_fortune_sheet}' が見つかりません。")
            # パートナー年別運勢の読み込み
            # シート名を正しく生成（関係性をタグに含めない）
            partner_fortune_sheet = "パートナー_年別運勢"
            partner_fortune_list = []
            if partner_fortune_sheet in wb.sheetnames:
                sheet = wb[partner_fortune_sheet]
                for row in sheet.iter_rows(min_row=2, values_only=True):
                    if row[0] is None:
                        continue
                    year = int(row[0])
                    # fortune_yearsが指定されており、その年のデータが含まれていない場合はスキップ
                    if fortune_years is not None and year not in fortune_years:
                        continue
                    # Excelから直接必要な情報を読み込む
                    partner_fortune_list.append({
                        "year": year,
                        "major_period": row[1],
                        "minor_period": row[2],
                        "annual_gz": row[3],  # 干支
                        "annual_stars": [s.strip() for s in str(row[4]).split(",")] if row[4] else [],  # 流曜
                        "four_transform_stars": [s.strip() for s in str(row[15]).split(",")] if row[15] else [],  # 流年四化星
                        # 追加の流年情報
                        "cai_bo_annual": str(row[5]).strip() if row[5] else "",   # 流年財帛宮
                        "jiao_you_annual": str(row[6]).strip() if row[6] else "", # 流年交友宮
                        "xiong_di_annual": str(row[7]).strip() if row[7] else "", # 流年兄弟宮
                        "ji_e_annual": str(row[8]).strip() if row[8] else "",     # 流年疾厄宮
                        "guan_lu_annual": str(row[9]).strip() if row[9] else "",  # 流年官禄宮
                        "ming_annual": str(row[10]).strip() if row[10] else "",   # 流年命宮
                        "fu_mu_annual": str(row[11]).strip() if row[11] else "",  # 流年父母宮
                        "zi_nu_annual": str(row[12]).strip() if row[12] else "",  # 流年子女宮
                        "fu_qi_annual": str(row[13]).strip() if row[13] else "",  # 流年夫妻宮
                        "qian_yi_annual": str(row[14]).strip() if row[14] else "" # 流年遷移宮
                    })
            else:
                raise ValueError(f"パートナー年別運勢シート '{partner_fortune_sheet}' が見つかりません。")
            # 7. 年運分析の実行
            print("STEP 6: Analyzing yearly fortune...")
            user_fortune_results = []
            for fortune_data in user_fortune_list:
                result = self.analyze_fortune(user_info, user_chart, fortune_data, relationship)
                user_fortune_results.append(result)
            partner_fortune_results = []
            for fortune_data in partner_fortune_list:
                result = self.analyze_fortune(partner_info, partner_chart, fortune_data, relationship)
                partner_fortune_results.append(result)
            # 8. Excel出力
            print("STEP 7: Exporting results to Excel...")
            # ユーザー年運分析結果をExcelに追加
            self.export_to_excel(
                user_fortune_list,
                user_fortune_results,
                user_info,
                output_file,
                prefix="ユーザー_"
            )
            # パートナー年運分析結果をExcelに追加
            self.export_to_excel(
                partner_fortune_list,
                partner_fortune_results,
                partner_info,
                output_file,
                prefix="パートナー_"
            )
            # 9. 関係性シートの追加
            print("STEP 8: Creating relationship sheet...")
            self.export_relationship_sheet(
                user_fortune_list,
                user_fortune_results,
                partner_fortune_list,
                partner_fortune_results,
                user_info,
                partner_info,
                output_file
            )
            # 10. グラフ出力
            print("STEP 9: Creating graphs...")
            output_dir = os.path.join(os.path.dirname(output_file), "graphs")
            os.makedirs(output_dir, exist_ok=True)
            self.create_fortune_timeline_graph(
                user_fortune_results,
                partner_fortune_results,
                user_info,
                partner_info,
                output_dir
            )
            print("="*50)
            print(f"紫微斗数最終処理プログラムが正常に完了しました")
            print(f"出力ファイル: {output_file}")
            print(f"グラフ出力ディレクトリ: {output_dir}")
            if fortune_years:
                print(f"分析対象年: {', '.join(map(str, fortune_years))}")
            print("="*50)
            return output_file
        except Exception as e:
            print("="*50)
            print(f"ERROR: Zi Wei Dou Shu final processing failed: {str(e)}")
            print("="*50)
            raise
    def calculate_annual_gz(self, year: int) -> str:
        """流年干支を計算"""
        # 単純化した実装（実際にはより複雑な計算が必要）
        gan_index = (year - 3) % 10
        zhi_index = (year - 3) % 12
        return f"{self.tian_gan[gan_index]}{self.di_zhi[zhi_index]}"
    def calculate_annual_stars(self, age: int, year: int) -> List[str]:
        """流曜を計算"""
        # 単純化した実装
        annual_stars = []
        # 小限の地支に基づく流曜
        minor_zhi_index = age % 12
        minor_zhi = self.di_zhi[minor_zhi_index]
        # 流曜のルール（簡略化）
        if minor_zhi == "子":
            annual_stars.append("龍徳")
        elif minor_zhi == "丑":
            annual_stars.append("白虎")
        elif minor_zhi == "寅":
            annual_stars.append("天徳")
        elif minor_zhi == "卯":
            annual_stars.append("月徳")
        elif minor_zhi == "辰":
            annual_stars.append("喪門")
        elif minor_zhi == "巳":
            annual_stars.append("貫索")
        elif minor_zhi == "午":
            annual_stars.append("官符")
        elif minor_zhi == "未":
            annual_stars.append("小耗")
        elif minor_zhi == "申":
            annual_stars.append("大耗")
        elif minor_zhi == "酉":
            annual_stars.append("龍徳")
        elif minor_zhi == "戌":
            annual_stars.append("白虎")
        elif minor_zhi == "亥":
            annual_stars.append("天徳")
        # 年齢に基づく追加流曜
        if age % 10 == 0:
            annual_stars.append("病符")
        elif age % 10 == 1:
            annual_stars.append("喜神")
        elif age % 10 == 2:
            annual_stars.append("飛廉")
        elif age % 10 == 3:
            annual_stars.append("奏書")
        return annual_stars
    def get_four_transformations(self, year: int) -> List[str]:
        """四化星を取得"""
        # 年干を取得（簡略化）
        year_gan_index = (year - 3) % 10
        year_gan = self.tian_gan[year_gan_index]
        return self.four_transformations.get(year_gan, [])

# ---
# メイン実行
if __name__ == "__main__":
    # 入力用EXCELファイル（中間処理プログラムで作成されたExcelファイル）
    excel_file = "石〇何某_天〇は反日_相性分析_中間結果.xlsx"
    # 分析する年を指定
    fortune_years = [1995, 2000, 2009, 2011, 2013, 2015 ,2020, 2022, 2025, 2026,]
    # ---
    # 最終処理実行
    try:
        print("="*50)
        print("紫微斗数最終処理プログラムを開始します")
        print("="*50)
        processor = ZiWeiDouShuFinal()
        output_file = processor.process(excel_file, fortune_years)
        print("="*50)
        print(f"最終処理が正常に完了しました")
        print(f"出力ファイル: {output_file}")
        if fortune_years:
            print(f"分析対象年: {', '.join(map(str, fortune_years))}")
        print("="*50)
    except Exception as e:
        print("="*50)
        print(f"最終処理でエラーが発生しました: {str(e)}")
        print("="*50)
        traceback.print_exc()
        sys.exit(1)

```

D先生： “さすが、長いプログラムですね。少しだけ結果を紹介してください。“

![imageINDS1-20-5](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-5.jpg) 

D先生：“これは、2013年に大活躍したI氏の運勢の詳細ですか・・・。それにしても、いきなり運勢スコアの項目が増えましたねえ。”

QEU:FOUNDER ： “いやいや・・・。これを増やしたのには訳があったんです。では、注目の推移グラフをみてみましょう。太い実線がI氏、細破線がA氏です。”

![imageINDS1-20-6](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-6.jpg) 

D先生：“WOW~!! それにしても、**かなり残酷なデータ**だなあ・・・。”

QEU:FOUNDER ： “えっ！？なにが残酷なんですか？”

D先生：“だって、40代の若手のときには、二人の能力値は、ほとんど変わらないじゃないですか。それが、近年になって大きな差がついています。政治は、純粋な**実力の世界**です。これは残酷でしょう？”

QEU:FOUNDER ： “納得・・・。そういう意味ね。小生は、その本質を知りたかったので**「成長」という項目**を付けたのです。中間プログラムも大改造したので、大変だったのですがね。”

![imageINDS1-20-7](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-7.jpg) 

D先生：“これだけの力量に差がついたのだ・・・。彼もグループになって戦うしかない。彼の政治（↑）は、**「お友達政治」**と批判されました。それには訳があったのですね。”

QEU:FOUNDER ： “あとね。すごくびっくりしたのだが、両者には大きな差があるんです。**このグラフには見えない**のだがね。”

D先生：“は？どういう、お話ですか？”

QEU:FOUNDER ： “この結果は、プロンプトを試行錯誤で変えていって、無理やり推移図を作ったのです。I氏の運勢は、プロンプトに対して、とても安定しています。以前の占星術の結果とほとんど同じでした。”

![imageINDS1-20-8](/2025-08-03-QEUR23_INDHS29/imageINDS1-20-8.jpg) 

D先生：“つまり、こんな感じ（↑）ですか？”

QEU:FOUNDER ： “そうです。その一方で、A氏の場合には、**プロンプトを変えると運勢の結果が大きく変わる**んです。彼（A氏）の運気は「弱い：ロバストではない」のです。”

D先生：“すごいなあ・・・。占いにも「ロバスト性」が出てきました。”

QEU:FOUNDER ： “これも、彼が「群れた」理由の一つだったと思います。”


## ～ まとめ ～

D先生：“さて、これで紫微斗数の占いプログラムの開発が終わりました。それにしても紫微斗数の威力はすごいですね。”

[![MOVIE1](http://img.youtube.com/vi/ehU0EUS5iiQ/0.jpg)](http://www.youtube.com/watch?v=ehU0EUS5iiQ "【教えてTaka先生！】紫微斗数 十四主星紹介 14.破軍星（はぐんせい）編")

QEU:FOUNDER ： “びっくりしたね。**J国は、A氏の破軍の影響をモロに受けた**わけです。”

[![MOVIE2](http://img.youtube.com/vi/9_jO3X2vBZA/0.jpg)](http://www.youtube.com/watch?v=9_jO3X2vBZA "大混乱の国会始まる。石破内閣少数与党。他もバラバラ･･･安冨歩東京大学名誉教授。")

D先生：“**占いにおけるロバスト性という新しい地平**も開拓できました（笑）。この占いシリーズをもう少しつづけますか？個人的には、大いに興味があります。”

QEU:FOUNDER ： “いやあ、AIで占いができるの命術は限られているでしょう。それは、いま検討中です。”

